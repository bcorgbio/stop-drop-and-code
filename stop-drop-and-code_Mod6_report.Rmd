---
title: "Module 6 Report"
author: "stop_drop_and_code"
date: "2022-11-06"
output: html_document
bibliography: BIOL3140.bib
---

## Wing Shape Evolution in the Lepidoptera

### Introduction
The Lepidoptera refers to the order of insects comprising of butterflies, moths, and skippers. Each of these organisms have two forewings and two hindwings, covered in scales. While there have been many papers written on the Lepidoptera, there is still much to learn about wing shape evolution in this group. @le2019adaptive explains that although correlations between wing shape variation and ecological factors have been estalished, the underlying selective pressures are still not clear. In addition to this, @owens2020comparative reports that forewing and hindwing evolution occurs independently, however, other studies like @chazot2016morpho report that there is a strong correlation between forewing and hindwing shapes (at least in the morpho group of butterflies). Due to this wide range of reports from different researchers, it is clear that more  analysis needs to be done to better understand wing development in the Lepidoptera. This project aims to elucidate whether or not fore- and hindwings vary in evolutionary rates, whether the evolvability of fore- and hindwings varies significantly among major lineages of moths and butterflies, and whether fore- and hindwing shape is correlated.

### Methods

*Are the rates of wing-shape evolution different between the hind- and forewing? By how much?* <br>
<br>
To analyze the rate of wing-shape evolution in the Lepidoptera, photos of specimens across the entire order were first compiled using images cataloged in the Global Biodiversity Information Facility database. Approximately 200 species were included in this report. Wing shape was then digitized with the image analysis program FIJI. <br>
<br>
Outline-based shape analysis was performed using an elliptical Fourier transformation. To account for arbitrary differences in wing size due to the orientation of the original photos and the lack of a scale bar in some cases, a generalized Procrustes transformation was first applied. With this outline data, Principal Components Analysis was used to quantify the amount of variance observed due to a particular principal component (PC). These operations were run with the R package Momocs. When outlines were separately analyzed according to whether they were fore- or hind-wing, separate PC scores were obtained and compared. 

*Have major lineages of the Lepidoptera undergone significant shifts in evolutionary rate?* <br>
<br>
The phylogenetic tree used in the analysis of this report was created by @kawahara2019. To compare the rates of evolution throughout major Lepidoptera lineages, the non-censored test  by @omeara2006 was used within the R package phytools. After eliminating species from the original phylogenetic tree that were not included in this report, evolutionary rates were calculated for the first and second PCs in fore- and hind-wings
<br>
Next, phylogenetic ridge regression by @kratsch2014 was performed from the R package RRphylo to determine whether any rate shifts were to a slower or faster rate. Once clades were identified to have undergone a rate shift, the lineage name was identified and the scale of the shift was plotted on the phylogenetic tree. 
<br>
*Are hind- and forewing shapes correlated?*<br>
<br>
Correlation between hind- and fore-wing shape evolution was analyzed with Phylogenetic Independent Contrasts (PIC) analysis. Hind- and fore-wing PC vectors were regressed against one another for PC1 and PC2 and a linear model was fitted to the data. 

### Results
```{r, "Setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(Momocs)
library(ape)
library(phytools)
library(RRphylo)
library(vroom)
library(ape)
library(ggtree)
library(wesanderson)
f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)
out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
out %>%
  list() %>%
  Out() %>%
  coo_flipx() %>%
  stack()
out.df <- vroom::vroom(f, id = "filename")
out.df <- out.df %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))
outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx()
forewings <- outs %>% 
  filter(wing=="forewing")
hindwings <- outs %>% 
  filter(wing=="hindwing")
```

```{r, "Shape Analysis: EFA and PCA", include=FALSE}
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()
forewings %>%
  coo_interpolate(fore.min) %>% 
  fgProcrustes() %>% 
  stack()
hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()
hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_slide(id=1) %>% 
  coo_align()  %>%
  fgProcrustes() %>%
  stack()

forewings %>%
  coo_interpolate(fore.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

forewing.pca <- forewings %>%
  coo_interpolate(fore.min) %>%
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwing.pca <- hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()
```
#### PCA Analysis 
```{r, echo=FALSE, message=FALSE}
forewing.pca %>% 
  plot_PCA(title = "forewings")

hindwing.pca %>% 
  plot_PCA(title = "hindwings")
```

#### Comparative Analysis
```{r, "Comparative Analysis", include=TRUE}
lep.tree <- ape::read.tree("lep_tree2.tre") %>% ladderize()
lep.tree$tip.label <- gsub("_"," ",lep.tree$tip.label)
plot(lep.tree,cex=0.1)
```

```{r, "Comparative Analysis Continued", include=FALSE}
lep.sp <- read_csv("lep_image_data.csv")
out.data <- tibble(xy.file=basename(names(outs))) %>% 
  mutate(identifier=gsub("XY_|_hindwing|_forewing|.txt","",xy.file)) %>% 
  left_join(lep.sp)
hindwing.pca2 <-  tibble(xy.file=basename(rownames(hindwing.pca$x)),PC1=hindwing.pca$x[,1],PC2=hindwing.pca$x[,2]) %>% 
  left_join(out.data)
forewing.pca2 <-  tibble(xy.file=basename(rownames(forewing.pca$x)),PC1=forewing.pca$x[,1],PC2=forewing.pca$x[,2])%>% 
  left_join(out.data)
```

```{r, "Evolutionary Rate Analysis", include=FALSE}
drops <- lep.tree$tip.label[!lep.tree$tip.label%in%unique(out.data$species)]
lep.tree2 <- drop.tip(lep.tree,drops)
#PC1s
hind.pc1 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull
names(hind.pc1) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)
fore.pc1 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(PC1)
names(fore.pc1) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)
#PC2s
hind.pc2 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)
names(hind.pc2) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>%
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
fore.pc2 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)
names(fore.pc2) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
```
#### Evolutionary Rates Analysis
```{r, "Evolutionary Rates", include=FALSE}
forePC1.BM<-brownie.lite(lep.tree2,fore.pc1*10)
hindPC1.BM<-brownie.lite(lep.tree2,hind.pc1*10)
forePC2.BM<-brownie.lite(lep.tree2,fore.pc2*10)
hindPC2.BM<-brownie.lite(lep.tree2,hind.pc2*10)
```

```{r, echo=FALSE}
forePC1.BM$sig2.single
forePC2.BM$sig2.single
hindPC1.BM$sig2.single
hindPC2.BM$sig2.single
```
#### Evolutionary Rates Shifts
```{r, echo=FALSE, message=FALSE}
hindPC1.RR <- RRphylo(tree=lep.tree2,y=hind.pc1)
hindPC2.RR <- RRphylo(tree=lep.tree2,y=hind.pc2)
forePC1.RR <- RRphylo(tree=lep.tree2,y=fore.pc1)
forePC2.RR <- RRphylo(tree=lep.tree2,y=hind.pc2)
hindPC1.SS<- search.shift(RR=hindPC1.RR,status.type="clade")
hindPC1.SS$single.clades
hindPC2.SS<- search.shift(RR=hindPC2.RR,status.type="clade")
hindPC2.SS$single.clades
forePC1.SS<- search.shift(RR=forePC1.RR,status.type="clade")
forePC1.SS$single.clades
forePC2.SS<- search.shift(RR=forePC2.RR,status.type="clade")
forePC2.SS$single.clades
```

```{r, echo=FALSE, message=FALSE}
plot_SS <- function(tre=NULL,SS=NULL,tax=NULL){
  

  nodes <- as.numeric(rownames(SS$single.clades))
  
  pal <- wes_palette("Zissou1",n=length(nodes))
  sp <- list()
  for(i in nodes){
    sp.i <- extract.clade(tre,i)$tip.label
    
    #print(head(tax))
    sub.names <- lapply(tax,function(x) x[x%in%sp.i]) 
    
    in.clades <- lapply(sub.names,function(x) length(x)>0) 
    all.of.clade <- lapply(sub.names,function(x) all(sapply(sp.i,function(z) z%in%x))) 
    
    high.clade <- names(sub.names)[last(which(all.of.clade==T))]
    all.clades <- names(sub.names)[which(in.clades==T)]
    crown <- ""
    if(high.clade!=last(names(sub.names))) crown <- "crown-"
    
    sub.clades <- NULL
    if(length(grepl("oidea",all.clades))>0) sub.clades <- all.clades[grepl("oidea",all.clades)]

    high.clade2 <- paste0(crown,high.clade,": ",paste0(sub.clades,collapse = "+"))
    sp[[paste0(i)]] <- tibble(n=i,species=sp.i,clade=high.clade2)
    
  }

  
  d <- do.call(rbind,sp)%>% 
    rename(label=species) 
  
  d2<- d %>% rename(clade_name=clade) 
  
  p <- ggtree(tre)+ scale_y_reverse()
  
  p$data <- p$data %>% left_join(d) %>% left_join(tibble(node=nodes,SS$single.clades) %>% mutate(shift=ifelse(rate.difference>0,"+","-")))
  
  p <-  p+geom_tiplab(aes(col=clade),geom="text",size=1.2)+
    geom_cladelab(data=d2,mapping=aes(node=n,col=clade_name,label=clade_name),offset=1,size=1.5)+
    geom_hilight(data=d2,mapping = aes(node = n,fill=clade_name),alpha = 0.01)+
    scale_fill_manual(values = pal)+
    scale_color_manual(values = pal)+
    theme(legend.position = "none")+geom_nodepoint(mapping=aes(subset = shift =="-"), size=5, shape=25,fill='blue',color='blue',alpha=0.7)+
    geom_nodepoint(mapping=aes(subset = shift =="+"), size=5, shape=24, fill='red',color='red',alpha=0.7)
  p <- p+xlim(NA,6)
  res <- tibble(n=nodes,SS$single.clades) %>% left_join(d %>% select(n,clade) %>% unique)
  
  return(list(plot=p,res=res))
  
}
tax.names <- readRDS("Lep_classification.RDS")
```
#### Forewing PC1
```{r, echo=FALSE, message=FALSE}
forePC1.res <- plot_SS(lep.tree2,forePC1.SS,tax = tax.names)
forePC1.res$plot
forePC1.res$res
```
#### Forewing PC2
```{r, echo=FALSE, message=FALSE}
forePC2.res <- plot_SS(lep.tree2,forePC2.SS,tax = tax.names)
forePC2.res$plot
forePC2.res$res
```
#### Hindwing PC1
```{r, echo=FALSE, message=FALSE}
hindPC1.res <- plot_SS(lep.tree2,hindPC1.SS,tax = tax.names)
hindPC1.res$plot
hindPC1.res$res
```
#### Hindwing PC2
```{r, echo=FALSE, message=FALSE}
hindPC2.res <- plot_SS(lep.tree2,hindPC2.SS,tax = tax.names)
hindPC2.res$plot
hindPC2.res$res
```
#### Shape Evolution Correlation
```{r, PIC for PC1}
hindPC1.pic <- pic(hind.pc1,phy = lep.tree2)
forePC1.pic <- pic(fore.pc1,phy = lep.tree2)
PC1.pic <- tibble(
  hind=hindPC1.pic,
  fore=forePC1.pic
)
PC1.pic %>% 
  ggplot(aes(x=fore,y=hind))+geom_point()+geom_smooth(method="lm")
summary(lm(hind~fore,PC1.pic))
```
```{r, PIC for PC2}
hindPC2.pic <- pic(hind.pc2,phy = lep.tree2)
forePC2.pic <- pic(fore.pc2,phy = lep.tree2)
PC2.pic <- tibble(
  hind=hindPC2.pic,
  fore=forePC2.pic
)
PC2.pic %>% 
  ggplot(aes(x=fore,y=hind))+geom_point()+geom_smooth(method="lm") #plot PIC PC2
summary(lm(hind~fore,PC2.pic)) #Find R-square
```

### Discussion
*(1)Do hind- and forewings vary in their evolutionary rates? (2)Does the evolvability of the hind- and forewings vary significantly among major lineages of moths and butterflies? (3)Is hindwing and forewing shape correlated?*


### Author Contributions 
Rachel Z. (Introduction)

Rachel R. (Methods, Bibliography)

Jordan Nunes (Discussion)

Michael Britt (Results, Digitization)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Bibliography