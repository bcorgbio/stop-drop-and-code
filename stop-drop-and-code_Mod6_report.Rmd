---
title: "Module 6 Report"
author: "stop_drop_and_code"
date: "2022-11-06"
output: html_document
bibliography: BIOL3140.bib
---

## Wing Shape Evolution in the Lepidoptera

### Introduction
The Lepidoptera refers to the order of insects comprising of butterflies, moths, and skippers. Each of these organisms have two forewings and two hindwings, covered in scales. @owens2020comparative reports that forewing and hindwing evolution occurs independently, however, other studies like @chazot2016morpho report that there is a strong correlation between forewing and hindwing shapes (at least in the morpho group of butterflies). Due to this wide range of reports from different researchers, it is clear that more  analysis needs to be done to better understand wing development in the Lepidoptera. This project aims to elucidate whether or not fore- and hindwings vary in evolutionary rates, whether the evolvability of fore- and hindwings varies significantly among major lineages of moths and butterflies, and whether fore- and hindwing shape is correlated.

### Methods

*Are the rates of wing-shape evolution different between the hind- and forewing? By how much?* <br>
<br>
To analyze the rate of wing-shape evolution in the Lepidoptera, photos of specimens across the entire order were first compiled using images cataloged in the Global Biodiversity Information Facility database. Approximately 200 species were included in this report. Wing shape was then digitized with the image analysis program FIJI. <br>
<br>
Outline-based shape analysis was performed using an elliptical Fourier transformation. To account for arbitrary differences in wing size due to the orientation of the original photos, a generalized Procrustes transformation was first applied. With this outline data, Principal Components Analysis was used to quantify the amount of variance observed due to a particular principal component (PC). These operations were run with the R package Momocs. When outlines were separately analyzed according to whether they were fore- or hind-wing, separate PC scores were obtained and compared. 

*Have major lineages of the Lepidoptera undergone significant shifts in evolutionary rate?* <br>
<br>
The phylogenetic tree used in the analysis of this report was created by @kawahara2019. To compare the rates of evolution throughout major Lepidoptera lineages, phylogenetic ridge regression by @kratsch2014 was used in the R package RRphylo.

*Are hind- and forewing shapes correlated?*

### Results
```{r, "Setup", include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(Momocs)
library(ape)
library(phytools)
library(RRphylo)
library(vroom)
library(ape)
library(ggtree)
library(wesanderson)

f <- list.files("class_out_data",pattern=".txt|.csv",full.names = TRUE)
out <- read_delim(f[1],delim="\t") %>% 
  as.matrix()
out %>%
  list() %>%
  Out() %>%
  coo_flipx() %>%
  stack()
out.df <- vroom::vroom(f, id = "filename")
out.df <- out.df %>% 
  mutate(wing=gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(filename))) %>% 
  na.omit()
outs.l <- sapply(f,function(x) out.df %>% filter(filename==x) %>% select(X,Y) %>% as.matrix)
wings <- gsub("XY_.+_(hindwing|forewing)\\..+","\\1",basename(names(outs.l)))
outs <-  outs.l %>% 
  Out(fac=list(wing=wings)) %>% 
  coo_flipx()
forewings <- outs %>% 
  filter(wing=="forewing")
hindwings <- outs %>% 
  filter(wing=="hindwing")
```

```{r, "Shape Analysis: EFA and PCA", include=FALSE}
fore.min <- forewings %>% 
  coo_nb() %>% 
  min()
forewings %>%
  coo_interpolate(fore.min) %>% 
  fgProcrustes() %>% 
  stack()
hind.min <- hindwings %>% 
  coo_nb() %>% 
  min()
hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_slide(id=1) %>% 
  coo_align()  %>%
  fgProcrustes() %>%
  stack()

forewings %>%
  coo_interpolate(fore.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  fgProcrustes() %>% 
  efourier(norm=FALSE) 

forewing.pca <- forewings %>%
  coo_interpolate(fore.min) %>%
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()

hindwing.pca <- hindwings %>% 
  coo_interpolate(hind.min) %>% 
  coo_align()  %>%
  coo_slide(id=1) %>% 
  fgProcrustes() %>% 
  efourier(norm=FALSE) %>% 
  PCA()
```
#### PCA Analysis 
```{r, echo=FALSE, message=FALSE}
forewing.pca %>% 
  plot_PCA(title = "forewings")

hindwing.pca %>% 
  plot_PCA(title = "hindwings")
```

```{r, "Comparative Analysis", include=FALSE}

lep.tree <- ape::read.tree("lep_tree2.tre")
lep.tree <- ladderize(lep.tree)
lep.tree$tip.label <- gsub("_"," ",lep.tree$tip.label)
lep.sp <- read_csv("lep_image_data.csv")
out.data <- tibble(xy.file=basename(names(outs))) %>% 
  mutate(identifier=gsub("XY_|_hindwing|_forewing|.txt","",xy.file)) %>% 
  left_join(lep.sp)
hindwing.pca2 <-  tibble(xy.file=basename(rownames(hindwing.pca$x)),PC1=hindwing.pca$x[,1],PC2=hindwing.pca$x[,2]) %>% 
  left_join(out.data)
forewing.pca2 <-  tibble(xy.file=basename(rownames(forewing.pca$x)),PC1=forewing.pca$x[,1],PC2=forewing.pca$x[,2])%>% 
  left_join(out.data)
```

```{r, "Evolutionary Rate Analysis", include=FALSE}
drops <- lep.tree$tip.label[!lep.tree$tip.label%in%unique(out.data$species)]
lep.tree2 <- drop.tip(lep.tree,drops)
#PC1s
hind.pc1 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull
names(hind.pc1) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)
fore.pc1 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(PC1)
names(fore.pc1) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC1=mean(PC1)) %>% 
  pull(species)
#PC2s
hind.pc2 <- hindwing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)
names(hind.pc2) <-  hindwing.pca2%>% 
    filter(species%in% lep.tree2$tip.label) %>% 
  group_by(species) %>%
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
fore.pc2 <- forewing.pca2 %>% 
    filter(species%in% lep.tree2$tip.label) %>% 
   group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(PC2)
names(fore.pc2) <-  forewing.pca2 %>% 
  filter(species%in% lep.tree2$tip.label) %>% 
     group_by(species) %>% 
  summarize(PC2=mean(PC2)) %>% 
  pull(species)
```
#### Evolutionary Rates Analysis
```{r, "Evolutionary Rates", include=TRUE}
forePC1.BM<-brownie.lite(lep.tree2,fore.pc1*10)
hindPC1.BM<-brownie.lite(lep.tree2,hind.pc1*10)

forePC2.BM<-brownie.lite(lep.tree2,fore.pc2*10)
hindPC2.BM<-brownie.lite(lep.tree2,hind.pc2*10)
```

### Discussion
*(1)Do hind- and forewings vary in their evolutionary rates? (2)Does the evolvability of the hind- and forewings vary significantly among major lineages of moths and butterflies? (3)Is hindwing and forewing shape correlated?*


### Author Contributions 
Rachel Z. (Introduction)
Rachel R. (Methods, Bibliography)
Jordan Nunes (Discussion)
Michael Britt (Results)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Bibliography